<link rel="stylesheet" href="/static/css/boards/view.css">
<link rel="stylesheet" href="/static/css/boards/comments.css">
<link rel="stylesheet" href="/static/css/level_system.css">

<div class="post-view">
  <!-- [ë³¸ë¬¸] í•œ ë°•ìŠ¤ -->
  <div class="card post-card">

    <!-- ì œëª© + ë©”íƒ€ (ì œëª© ì•„ë˜ë§Œ ì„ ) -->
    <div class="header">
      <h1 class="post-title">{{ post.title }}</h1>
      <div class="post-meta">
        <span>ì‘ì„±ì: 
          <span class="level-badge level-{{ post.level }}" style="font-size: 11px; padding: 2px 6px; margin-right: 6px;">
            Lv.{{ post.level }}
          </span>
          {{ post.author }}
        </span>
        <span>ì‘ì„±ì¼ {{ post.created_at_fmt }}</span>
        {% if post.updated_at_fmt and post.updated_at_fmt != post.created_at_fmt %}
          <span>ìˆ˜ì •ì¼ {{ post.updated_at_fmt }}</span>
        {% endif %}
        <span>ì¡°íšŒ {{ post.views }}</span>
        <span>ì¶”ì²œ {{ post.likes }}</span>
        <span>ì¹´í…Œê³ ë¦¬: {{ post.category if post.category else 'ë¯¸ì§€ì •' }}</span>
      </div>
    </div>

    <!-- ë³¸ë¬¸ -->
    <div class="body">
      <div class="content">{{ post.content | safe }}</div>
    </div>

    <!-- íˆ´ë°”: ì‘ì„±ì/ê´€ë¦¬ìì¼ ë•Œë§Œ ë Œë” -->
    {% if current_user and (current_user.is_admin or current_user.id == post.user_id) %}
    <div class="toolbar">
      <div class="post-actions">
        <a href="/invest/edit/{{ post.id }}" class="btn btn--sm">ìˆ˜ì •</a>
        <form method="post" action="/invest/delete/{{ post.id }}" style="display:inline"
              onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
          <button type="submit" class="btn btn--danger btn--sm">ì‚­ì œ</button>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- íˆíŠ¸/í­ë§ íˆ¬í‘œ -->
    <div class="votebar">
      <div class="vote-info">
        <!-- í˜„ì¬ í¬ì¸íŠ¸ ë°•ìŠ¤ ì œê±° -->
      </div>
      <div class="vote-buttons">
        <button class="vote vote--hit" id="hitButton" onclick="votePost('hit')" {% if not current_user %}disabled{% endif %}>
          ğŸ¯ íˆíŠ¸ <span class="count" id="hitCount">{{ post.likes or 0 }}</span>
        </button>
        <button class="vote vote--bomb" id="bombButton" onclick="votePost('bomb')" {% if not current_user %}disabled{% endif %}>
          ğŸ’£ í­ë§ <span class="count" id="bombCount">{{ post.dislikes or 0 }}</span>
        </button>

        <!-- í¬ì¸íŠ¸ ë¶€ì¡± ì•ˆë‚´ ë¬¸êµ¬ëŠ” ê¸°ë³¸ ìˆ¨ê¹€ ì²˜ë¦¬ -->
        <p id="point-warning" class="point-warning" hidden>
          í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: 5, ë³´ìœ : {{ current_user.points if current_user else 0 }})
        </p>
      </div>
    </div>

    <!-- ê³µìœ  / ë„¤ë¹„ (ëª©ë¡ìœ¼ë¡œë§Œ ìœ ì§€) -->
    <div class="share-nav">
      <div class="sharebar">
        <a class="mini" href="#" onclick="navigator.clipboard.writeText(location.href);return false;">ë³µì‚¬</a>
        <a class="mini" href="/report/{{ post.id }}">ì‹ ê³ </a>
      </div>
      <div class="navline">
        <a class="nav" href="/invest?page={{ page }}">ëª©ë¡ìœ¼ë¡œ</a>
        {% if prev_id %}<a class="nav" href="/invest/view/{{ prev_id }}">ì´ì „ ê¸€ &lt;</a>{% endif %}
        {% if next_id %}<a class="nav" href="/invest/view/{{ next_id }}">&gt; ë‹¤ìŒ ê¸€</a>{% endif %}
      </div>
    </div>
  </div>

  <!-- [ëŒ“ê¸€] ë³„ë„ ë°•ìŠ¤ (ì•„ë°”íƒ€ ì œê±°) -->
  <div class="card comments">
    <h3>ëŒ“ê¸€</h3>

    {% if comments and comments|length > 0 %}
      <div class="comment-list">
        {% for c in comments %}
          <div class="comment" data-comment-id="{{ c.id }}">
            <div class="comment-header">
              <div class="meta">
                <span class="author">{{ c.author }}</span>
                <span class="kst">{{ c.created_at_fmt }}</span>
                {% if c.updated_at_fmt and c.updated_at_fmt != c.created_at_fmt %}
                  <span class="edited">(ìˆ˜ì •ë¨)</span>
                {% endif %}
              </div>
              {% if current_user and (current_user.is_admin or current_user.nickname == c.author) %}
              <div class="comment-actions">
                <button class="btn btn--sm btn--edit" onclick="editComment('{{ c.id }}')" data-comment-id="{{ c.id }}">ìˆ˜ì •</button>
                <form method="post" action="/invest/comment/{{ post.id }}/delete/{{ c.id }}" 
                      style="display:inline" onsubmit="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                  <button type="submit" class="btn btn--sm btn--danger">ì‚­ì œ</button>
                </form>
              </div>
              {% endif %}
            </div>
            <div class="body" id="comment-content-{{ c.id }}">{{ c.content | safe }}</div>
            <div class="edit-form" id="edit-form-{{ c.id }}" style="display: none;">
              <form method="post" action="/invest/comment/{{ post.id }}/edit/{{ c.id }}">
                <textarea name="content" required>{{ c.content }}</textarea>
                <div class="edit-actions">
                  <button type="submit" class="btn btn--sm btn--primary">ì €ì¥</button>
                  <button type="button" class="btn btn--sm" onclick="cancelEdit('{{ c.id }}')" data-comment-id="{{ c.id }}">ì·¨ì†Œ</button>
                </div>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}

    <div class="comment-box">
      <div class="input">
        <form method="post" action="/invest/comment/{{ post.id }}"
              class="comment-form {% if not current_user %}comment-form--disabled{% endif %}">
          <textarea name="content"
            placeholder="{% if current_user %}ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”{% else %}ëŒ“ê¸€ ì‘ì„± í•˜ì‹œë ¤ë©´ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”{% endif %}"
            required {% if not current_user %}disabled{% endif %}></textarea>
          <div class="comment-actions">
            <button type="submit" class="btn btn--primary btn--sm" {% if not current_user %}disabled{% endif %}>
              ëŒ“ê¸€ ë“±ë¡
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function editComment(commentId) {
  // ëŒ“ê¸€ ë‚´ìš©ê³¼ ìˆ˜ì • í¼ì„ í† ê¸€
  const contentId = `comment-content-${commentId}`;
  const formId = `edit-form-${commentId}`;
  
  document.getElementById(contentId).style.display = 'none';
  document.getElementById(formId).style.display = 'block';
}

function cancelEdit(commentId) {
  // ìˆ˜ì • í¼ì„ ìˆ¨ê¸°ê³  ëŒ“ê¸€ ë‚´ìš©ì„ ë‹¤ì‹œ í‘œì‹œ
  const contentId = `comment-content-${commentId}`;
  const formId = `edit-form-${commentId}`;
  
  document.getElementById(contentId).style.display = 'block';
  document.getElementById(formId).style.display = 'none';
}

// íˆíŠ¸/í­ë§ íˆ¬í‘œ ê¸°ëŠ¥
let currentVote = null;

async function votePost(voteType) {
  {% if not current_user %}
  alert('íˆ¬í‘œí•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  return;
  {% endif %}
  
  const hitButton = document.getElementById('hitButton');
  const bombButton = document.getElementById('bombButton');
  const hitCount = document.getElementById('hitCount');
  const bombCount = document.getElementById('bombCount');
  const pointWarning = document.getElementById('point-warning');
  
  // í˜„ì¬ ì‚¬ìš©ìì˜ í¬ì¸íŠ¸ í™•ì¸ (í—¤ë”ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
  const headerPoints = document.querySelector('.auth-user .user-points');
  if (!headerPoints) {
    alert('í¬ì¸íŠ¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  const currentPoints = parseInt(headerPoints.textContent.replace('ğŸ’° ', ''), 10);
  
  // í¬ì¸íŠ¸ ë¶€ì¡± ì‹œ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
  if (currentPoints < 5) {
    pointWarning.hidden = false;
    return;
  } else {
    // í¬ì¸íŠ¸ê°€ ì¶©ë¶„í•˜ë©´ ì•ˆë‚´ ë¬¸êµ¬ ìˆ¨ê¹€
    pointWarning.hidden = true;
  }
  
  try {
    const formData = new FormData();
    formData.append('post_id', '{{ post.id }}');
    formData.append('vote_type', voteType);
    
    const response = await fetch('/vote', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      if (data.action === 'voted') {
        // ìƒˆë¡œ íˆ¬í‘œí•œ ê²½ìš°
        if (voteType === 'hit') {
          hitCount.textContent = parseInt(hitCount.textContent) + 1;
          currentVote = 'hit';
        } else {
          bombCount.textContent = parseInt(bombCount.textContent) + 1;
          currentVote = 'bomb';
        }
        
        // í—¤ë”ì˜ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
        headerPoints.textContent = `ğŸ’° ${currentPoints - 5}`;
        
        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateButtonStates();
        
        alert(data.message);
      } else if (data.action === 'cancelled') {
        // íˆ¬í‘œ ì·¨ì†Œí•œ ê²½ìš°
        if (voteType === 'hit') {
          hitCount.textContent = parseInt(hitCount.textContent) - 1;
        } else {
          bombCount.textContent = parseInt(bombCount.textContent) - 1;
        }
        
        // í—¤ë”ì˜ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
        headerPoints.textContent = `ğŸ’° ${currentPoints + 5}`;
        
        currentVote = null;
        updateButtonStates();
        
        alert(data.message);
      }
    } else {
      alert(data.detail || 'íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

function updateButtonStates() {
  const hitButton = document.getElementById('hitButton');
  const bombButton = document.getElementById('bombButton');
  const userPoints = document.getElementById('userPoints');
  const currentPoints = parseInt(userPoints.textContent);
  
  // í¬ì¸íŠ¸ ë¶€ì¡± ì‹œ ë²„íŠ¼ ë¹„í™œì„±í™”
  if (currentPoints < 5) {
    hitButton.disabled = true;
    bombButton.disabled = true;
  } else {
    hitButton.disabled = false;
    bombButton.disabled = false;
  }
  
  // í˜„ì¬ íˆ¬í‘œ ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼
  if (currentVote === 'hit') {
    hitButton.classList.add('voted');
    bombButton.classList.remove('voted');
  } else if (currentVote === 'bomb') {
    bombButton.classList.add('voted');
    hitButton.classList.remove('voted');
  } else {
    hitButton.classList.remove('voted');
    bombButton.classList.remove('voted');
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ íˆ¬í‘œ ìƒíƒœ í™•ì¸
async function checkVoteStatus() {
  try {
    const response = await fetch(`/vote-status/{{ post.id }}`);
    const data = await response.json();
    
    if (data.voted) {
      currentVote = data.vote_type;
    }
    
    // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    document.getElementById('hitCount').textContent = data.likes_count;
    document.getElementById('bombCount').textContent = data.dislikes_count;
    
    // í¬ì¸íŠ¸ í™•ì¸
    if (data.can_vote === false) {
      document.getElementById('hitButton').disabled = true;
      document.getElementById('bombButton').disabled = true;
    }
    
    updateButtonStates();
  } catch (error) {
    console.error('Error checking vote status:', error);
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
  checkVoteStatus();
});
</script>
